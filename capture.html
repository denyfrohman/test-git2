<?php
date_default_timezone_set('Asia/Jakarta');
require_once('../conn.php');

//$sql = "SELECT member_id, google_id, person_email, refresh_token, flag, error_msg FROM gofit";
$sql = "SELECT member_id, google_id, person_email, refresh_token, flag, error_msg FROM gofit 
WHERE person_email = 'musatanaja@gmail.com'";
		$stmt = $db->prepare($sql); 
		//$stmt->bind_param("i", $id);
		$stmt->execute();
		$result = $stmt->get_result();
while ($row = $result->fetch_assoc()) {
			$arrival = new DateTimeImmutable();
			$createdate = $arrival->format("Y-m-d H:i:s");
			$starttime = "00:00:00";
			$endtime = "23:59:59";
			$start_date_yesterdy = $arrival->modify( '-1 day' )->format('Y-m-d '.$starttime);
			$start_stamp = strtotime($start_date_yesterdy);  
			$start_time_in_ms = $start_stamp*1000;
			$end_date_yesterdy = $arrival->modify( '-1 day' )->format('Y-m-d '.$endtime);
			$end_stamp = strtotime($end_date_yesterdy);
			$end_time_in_ms = $end_stamp*1000 ;
			//$durationMillis = "86400000";
			$durationMillis = "3600000";
			echo "<br>".$start_date_yesterdy;
			//echo "<br>".$start_time_in_ms;
			echo "<br>".$end_date_yesterdy."<br>";
			//echo "<br>".$end_time_in_ms."<br>";


			$member_id = $row['member_id'];
			$google_id = $row['google_id'];
			$email = $row['person_email'];
			$rf_token = $row['refresh_token'];
			$s_flag = $row['flag'];
			$s_error_msg = $row['error_msg'];
				$sql1 = 	"SELECT u.username AS username FROM alacards_users_app u, alacards_card_list cl WHERE 
				u.appid=10028 AND cl.memberid= ? AND cl.merchantid=u.appid AND cl.status=0 AND cl.userid=u.userid";
				$stmt1 = $db->prepare($sql1); 
				$stmt1->bind_param("s", $member_id);
				$stmt1->execute();
				$result1 = $stmt1->get_result();
				$row1 = $result1->fetch_assoc(); 
				$username = $row1['username'];
				$stmt1->close();
			//echo $username."<br>";
			//echo $member_id."<br>";
			//echo $google_id."<br>";
			echo $email."<br><br>";
			//echo $rf_token."<br>";
			//echo $s_flag."<br>";
			//echo $s_error_msg."<br> <br>";
					
			$url = 'https://oauth2.googleapis.com/token';

			$data = array(
			    'client_secret' 	=> 'tLlWUr_R5UPAX8NE1JCQ64xt',
				'grant_type'	=> 'refresh_token',
				'refresh_token' 	=> ''.$rf_token.'',
				'client_id'	=> '928093367606-q8bisjdn4tln2e169d507134flojqpcg.apps.googleusercontent.com'
			);

			/*$body = json_encode($data);

			$ch = curl_init($url);

			curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
			curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			curl_setopt($ch, CURLOPT_TIMEOUT, 30);	
			curl_setopt($ch, CURLOPT_POST, true);	

			$response = curl_exec($ch);	
			$err = curl_errno($ch);
			$errmsg = curl_error($ch);
			$header = curl_getinfo($ch);
			curl_close($ch);
			$res = json_decode($response, true);
			//echo "response 1".$response."<br>";
			$access_token = isset($res['access_token']) ? $res['access_token'] : "";*/

			$body = json_encode($data);

			$ch = curl_init($url);

			curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
			curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			curl_setopt($ch, CURLOPT_TIMEOUT, 30);	
			curl_setopt($ch, CURLOPT_POST, true);	

			$response = curl_exec($ch);	
			//$err = curl_errno($ch);
			$errmsg = curl_error($ch);
			$header = curl_getinfo($ch);
			if (curl_errno($ch) === CURLE_OK) {
			    //echo 'sukses 1' . $errmsg."<br>";
			    $res = json_decode($response, true);
				//echo "response 1".$response."<br>";
				$access_token = isset($res['access_token']) ? $res['access_token'] : "";
			}elseif(curl_errno($ch)){
			    //echo 'Request Error 1:' . $errmsg."<br>";
			    $access_token = "error";
			}
			curl_close($ch);
			
			if ($access_token == "error"){
				$flag = -3;
				$status = $errmsg;
				updateGofitError($db,$flag, $status,$member_id);
			}elseif($access_token != ''){
				$url = 'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate';

					$data = array(
				    'aggregateBy' 	=> 
				    	array('dataSourceId' => 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps'),
					'bucketByTime'	=> 
						array('durationMillis' => $durationMillis),
					'startTimeMillis'	=> $start_time_in_ms,
					'endTimeMillis' => $end_time_in_ms
					);

				$body = json_encode($data);

				$ch = curl_init($url);

				curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
				curl_setopt($ch, CURLOPT_HTTPHEADER, array(
					'Content-Type:application/json',
					'Authorization: Bearer '.$access_token.''
				));
				curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
				curl_setopt($ch, CURLOPT_TIMEOUT, 30);	
				curl_setopt($ch, CURLOPT_POST, true);	

				/*$response = curl_exec($ch);	
				$err = curl_errno($ch);
				$errmsg = curl_error($ch);
				$header = curl_getinfo($ch);
				curl_close($ch);
				$res = json_decode($response, true);*/
				$response = curl_exec($ch);	
				//$err = curl_errno($ch);
				$errmsg = curl_error($ch);
				$header = curl_getinfo($ch);
				if (curl_errno($ch) === CURLE_OK) {
				    //echo 'sukses 2' . $response."<br><br>";
				    $res = json_decode($response, true);
				}elseif(curl_errno($ch)){
					    //echo 'Request Error 2:' . $errmsg."<br><br>";
					$res = "error";
				}
				curl_close($ch);
				if ($res == "error"){
					$flag = -3;
					$status = $errmsg;
				}else{
					foreach ($res  as $name => $var){
					   if($name == 'bucket'){
					   	$total = '0';
					   	for ($x = 0; $x <= 23; $x+=1) {
					   		$startTimeMillis = $var[$x]["startTimeMillis"]; 
							$endTimeMillis = $var[$x]["endTimeMillis"];
							
							if($var[$x]["dataset"][0]["point"] == null){
								$intVal = 0;
								$originDataSourceId = $var[$x]["dataset"][0]["dataSourceId"];
							}else{
							   	$intVal = $var[$x]["dataset"][0]["point"][0]["value"][0]["intVal"];
							   	$originDataSourceId = $var[$x]["dataset"][0]["point"][0]["originDataSourceId"];
							} 
							$word = "user_input";
							 
							// Test if string contains the word 
							if(strpos($originDataSourceId, $word) !== false){
							    echo "User Input";
							    $total += $intVal;
							} else{
							    echo ""; 
							    $total += $intVal;
							}

					      	if ($x <= 8){
					        	$y = $x+1;
					        	echo "[".$intVal."] 0".$x.":00:00 ~ 0".$y.":00:00 |".$originDataSourceId."<br>";
					      	}else{
					        	$y = $x+1;
					        	if ($y == 9){
					            	echo "[".$intVal."] 0".$x.":00:00 ~ ".$y.":00:00 |".$originDataSourceId."<br>";
					      		}elseif($y == 24){
						      		$y = $x+1;
						    		echo "[".$intVal."] ".$x.":00:00 ~ ".$x.":59:59 |".$originDataSourceId."<br>";
						    	}else{
					        		echo "[".$intVal."] ".$x.":00:00 ~ ".$y.":00:00 |".$originDataSourceId."<br>";
					            }
					      	}
						}	
						echo $total;
					   	/*for ($x = 0; $x <= 23; $x++) {
							  $startTimeMillis = $var[$x]["startTimeMillis"]; 
							  $endTimeMillis = $var[$x]["endTimeMillis"];
							  if($var[$x]["dataset"][0]["point"] == null){
							   $intVal = 0;
							  }else{
							   $intVal = $var[$x]["dataset"][0]["point"][0]["value"][0]["intVal"];
							  }
								$seconds = $startTimeMillis / 1000;
								$dateku = date("Y-m-d", $seconds);
								$flag = 1;
								$status = " ";
								echo $intVal."<br>";
						 }*/
						}else{
						   		$status = $var["status"]; 
							  	$intVal = 0;
							  	$flag = -2;	  	
								$judul = "wearable";
								$isi = "akun wearable anda belum pernah dipakai di aplikasi google fit silahkan login ke aplikasi google fit terlebih dahulu";
					   };
					};
				};
			}else{
				$flag = -1;
				$intVal = 0;
				$status = $res['error_description'];
				$judul = "wearable";
				$isi = "akun wearable anda sudah expired silahkan login kembali";
			}
}
?>



